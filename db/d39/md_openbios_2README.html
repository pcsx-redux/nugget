<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Nugget: OpenBIOS</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Nugget
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">OpenBIOS</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md11"></a> </p>
<h1><a class="anchor" id="autotoc_md12"></a>
Purpose of this project</h1>
<p>There are several goals from the code in this directory.</p>
<h2><a class="anchor" id="autotoc_md13"></a>
Educational</h2>
<p>Writing an emulator requires extensive knowledge of the machine being emulated. The BIOS of the PlayStation is part of it, and is obviously required to boot the machine and start games. This work is done so that both the author and the reader can perfect their understanding of its internals.</p>
<p>As a result, the code written here tries to be as close as possible to the original, bugs, quirks and all included. You may notice some anti-patterns while reading the code, like buffer overflows or arithmetic mistakes. They are intentional, and a direct reflection of what the retail BIOS does. Some of these bugs are weird enough that it's difficult to infer the original buggy C code, while still understanding the general intent. Some of these bugs are severe enough that they have been fixed, but mentions are usually added to explain what changed and why.</p>
<p>Note that the generated binary will be nowhere close to the original rom this is inspired from. This is caused by several different factors: codestyle isn't identical for a start, and some optimizations have been put in place still, such as the way syscalls are being issued. Linking order will also throw off some of the mappings. And finally, today's compilers generate much smarter code than before. So the same C code won't generate the same assembly code for two different compilers. There is also some dead or duplicated code in there that'd be useless or meaningless to reproduce. Finally, the shell itself is radically different.</p>
<h2><a class="anchor" id="autotoc_md14"></a>
Ease of distribution</h2>
<p>While dumping an original PlayStation disc is something that is fairly easy to do for anyone using any sort of compact disc reader connected to a personal computer, dumping the bios of a retail machine, while not impossible, is a somewhat harder feat. As a result, people are often relying on bios dumps done by third party people, which ought to be considered copyright violation. Also, some emulators have a "HLE" bios, which creates a maintenance burden for each emulator, as well as being a complex mix of LLE and HLE code.</p>
<h2><a class="anchor" id="autotoc_md15"></a>
Testing</h2>
<p>Any recent project needs automated testing. Having source code available for all parts of the emulator will improve testing availability and test coverage, hopefully, for both the emulator, and the bios code.</p>
<h1><a class="anchor" id="autotoc_md16"></a>
Building</h1>
<p>The currently supported build method for this project requires docker. You can use the <code>dockermake.sh</code> script at the root of the repository as a replacement for the <code>make</code> command, and use the <code>Makefile</code> present here. Under Windows, the <code>build.bat</code> can be used. If using <a href="https://code.visualstudio.com/">Visual Studio Code</a>, one can use the task "make_openbios" to compile: CTRL-P then <code>task make_openbios</code> to compile.</p>
<p>It is also possible to build using any PS1 compatible compiler, but this isn't the current method used in the CI, so it's mostly untested. Check <a class="el" href="../../d3/d4b/md_psyqo_2GETTING__STARTED.html">PSYQo's getting started</a> document to install such toolchain in case docker isn't an acceptable solution to build this project.</p>
<p>The result of the compilation should be a file called <code>openbios.elf</code> that contains all useful debugging symbols, and a file called <code>openbios.bin</code> which can be used in emulators or even burned to a chip and placed on a retail console.</p>
<p>The Makefile features several toggles to mutate the way the compilation works. Don't forget to run <code>make clean</code> prior to try a different set of compilation options.</p>
<ul>
<li><code>BUILD=SmallDebug</code> will produce a working, yet somewhat debuggable version of the code.</li>
<li><code>BOOT=cart</code> will build the kernel as an expansion port ROM, bootable from an Action Replay or similar cheat carts. This will disable support for booting from a cart in order to prevent bootlooping.</li>
<li><code>BOARD=system573</code> will build a kernel that can run on the Konami System 573 arcade board. Note that this option is only useful alongside <code>EMBED_PSEXE</code>, as it will force <code>BOOT=rom</code> and <code>BOOT_MODE=psexe</code> due to the 573's different CD-ROM hardware.</li>
<li><code>EMBED_PSEXE=binary.ps-exe</code> will embed the specified executable into the kernel and run it before the shell.</li>
<li><code>BOOT_MODE=fast</code> will skip running the shell and try booting from the CD-ROM after the embedded executable returns, or immediately on boot if <code>EMBED_PSEXE</code> is not used. Note that the code will <em>not</em> wait for a disc to be inserted after the executable returns. The old <code>FASTBOOT=true</code> option is kept for compatibility and is equivalent to <code>BOOT_MODE=fast</code>.</li>
<li><code>BOOT_MODE=psexe</code> will remove the shell and CD-ROM boot code altogether. This is meant to be used alongside <code>EMBED_PSEXE</code> to build ROMs for arcade systems and such, which typically use non-standard storage devices and require a custom shell.</li>
<li><code>SPLASH_SCREEN=true</code> will make the kernel display color bars on screen during initialization. This is also done by some official non-retail BIOS variants and is useful when using the <code>EMBED_PSEXE</code> option with a large (100+ KB) binary, as relocating it to RAM will take a couple of seconds.</li>
<li><code>INSTALL_TTY_CONSOLE=true</code> will make OpenBIOS install a DTL-H2000 host console driver in place of the default "dummy" TTY driver. Note that this is <em>not</em> the DUART driver found in a retail BIOS.</li>
</ul>
<h1><a class="anchor" id="autotoc_md17"></a>
Status</h1>
<p>This subproject is fairly functional and usable. OpenBIOS does almost all the same things as the retail BIOS does when booting, and implements most of its features. <a href="https://docs.google.com/spreadsheets/d/1UNGs7uYb8viAbm7YJaf1CR4dkgX7ZzntUdcowGsjcVc/edit?usp=sharing">Many games</a> are booting and working properly with this code. It can be used in emulators or on the real console, either while replacing the rom chip, or by using the "cart" build and programming the flash chip of a cheat cart with the result.</p>
<p>Please feel free to report bugs encountered while using this project.</p>
<h1><a class="anchor" id="autotoc_md18"></a>
Organization</h1>
<p>The BIOS is split in two major parts: the low level code for the bios itself, and the shell, which is the binary that's being loaded into memory at boot time by the bios, to display the SONY sound and logo, and has a small utility menu for playing audio discs, or shuffling around memory cards.</p>
<p>While the first part is the main one that's being targeted here, the second one hasn't been reversed, and fully replaced with a completely different project. This may change in the future, but this isn't currently the focus of this project.</p>
<p>The original code was most likely chunked into several sub-projects, that were all linked together like a giant patchwork. This approach is less readable, and for this reason, we're not going to do this. However this will result in the ROM/RAM split to be less obvious, and slower at times than the original. Tuning of the hot functions is eventually required.</p>
<p>The startup point for the ROM version is the function <code>_reset</code> located in <a href="../../boot/psx.s"><code>boot/psx.s</code></a> (or <a href="../../boot/system573.s"><code>boot/system573.s</code></a> depending on which board the kernel is compiled for). The rom cart version is the function <code>_cartBoot</code> in the same file.</p>
<h1><a class="anchor" id="autotoc_md19"></a>
Direction</h1>
<p>The primary repository for this project is a subdirectory of PCSX-Redux at the moment, because building, testing and integration as a single bloc of code is much more practical than separate repositories. If the need arise however, it should be possible to move it as a separate repository elsewhere. There is currently a <a href="https://github.com/pcsx-redux/nugget/tree/main/openbios">buildable read-only mirror available</a>.</p>
<h1><a class="anchor" id="autotoc_md20"></a>
Technicalities</h1>
<p>The code has been rewritten based off the reverse engineering of a dump of the BIOS of an american SCPH-7001 machine (MD5 <code>1e68c231d0896b7eadcad1d7d8e76129</code>). The System 573 specific parts are based on the kernel of the Konami 700B01 ROM (MD5 <code>d6960997e499f39047b64fa73e6ff382</code>).</p>
<p>The ghidra database for it is currently being hosted on a server, alongside a few other pieces of software being reversed. Contact one of the authors if you want access.</p>
<h1><a class="anchor" id="autotoc_md21"></a>
Commentary</h1>
<p>The retail PlayStation BIOS code is a constellation of bugs and bad design. It is very obvious the code has been written hastily, likely by different teams having little to no communication with each other, under heavy time pressure. The fact that the retail console boots at all is nothing short of a miracle. Half of the provided libc in the A0 table is buggy. The BIOS code is barely able to initialize the CD-Rom, and read the game's binary off of it to boot it; anything beyond that will be crippled with bugs. And this only is viable if you respect a very strict method to create your CD-Rom. The memory card and gamepad code is a steaming-hot heap of human excrement. The provided GPU stubs are inefficient at best. The only sane thing that any software running on the PlayStation ought to do is to immediately disable interrupts, and then trash the whole memory to install its own code. Anything from the retail code is virtually useless, and shouldn't be relied upon. That being said, doing so will prevent tools from functioning properly, like cheat software, unirom, or even emulators that are sniffing the kernel to do debugging and reporting.</p>
<h1><a class="anchor" id="autotoc_md22"></a>
Legality</h1>
<p><em>Disclaimer: the author is not a lawyer, and the following statement hasn't been reviewed by a professional of the law, so the rest of this document cannot be taken as legal advice.</em></p>
<p>As explained above, this code has been written using disassembly and reverse engineering of a retail bios the author dumped from a second hand console. The same exact methodology was employed by Connectix for their PS1 bios. The conclusion of <a href="https://en.wikipedia.org/wiki/Sony_Computer_Entertainment,_Inc._v._Connectix_Corp.">their lawsuit</a>, and that of <a href="https://en.wikipedia.org/wiki/Sega_Enterprises,_Ltd._v._Accolade,_Inc.">Sega v. Accolade</a> seems to indicate that this project here follows and is impacted by the same doctrine. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
